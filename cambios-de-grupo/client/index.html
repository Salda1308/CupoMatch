<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cambios de Grupo - SID</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        header h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        header .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #e0f2fe;
            color: #0369a1;
            border-left: 4px solid #0369a1;
        }

        .alert-success {
            background: #dcfce7;
            color: #15803d;
            border-left: 4px solid #15803d;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #991b1b;
        }

        .solicitud-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .solicitud-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .solicitud-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .materia-nombre {
            font-weight: 700;
            color: #667eea;
        }

        .grupos-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
            font-size: 0.9em;
        }

        .grupo-oferta, .grupo-solicita {
            padding: 8px;
            border-radius: 4px;
        }

        .grupo-oferta {
            background: #f3e8ff;
            color: #6d28d9;
        }

        .grupo-solicita {
            background: #dbeafe;
            color: #1e40af;
        }

        .estudiante-info {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            font-size: 0.9em;
            color: #666;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-activa {
            background: #d1fae5;
            color: #065f46;
        }

        .status-cerrada {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-completada {
            background: #dcfce7;
            color: #15803d;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            color: #999;
            font-size: 1.2em;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 60px;
            height: 60px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px rgba(0, 0, 0, 0.15);
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            cursor: pointer;
            font-size: 1.5em;
            color: #999;
            background: none;
            border: none;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .tab {
            padding: 12px 0;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            color: #999;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .interesados-list {
            margin-top: 15px;
        }

        .interesado-item {
            background: #f9fafb;
            border-radius: 5px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 3px solid #667eea;
        }

        .interesado-nombre {
            font-weight: 600;
            color: #333;
        }

        .interesado-contacto {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .copy-btn {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéì Sistema de Cambios de Grupo</h1>
            <p class="subtitle">Conecta con otros estudiantes para intercambiar grupos</p>
            <div class="header-actions" id="headerActions">
                <button class="btn-secondary" onclick="mostrarLogin()">Iniciar Sesi√≥n</button>
            </div>
        </header>

        <div class="main-content" id="mainContent">
            <!-- Secci√≥n de Login -->
            <div id="loginSection" class="card">
                <h2>üîê Acceso</h2>
                <p style="margin-bottom: 20px; color: #666;">
                    Usa tu c√≥digo de estudiante y tel√©fono para acceder sin contrase√±a.
                </p>
                <form id="loginForm" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label for="codigo">C√≥digo de Estudiante</label>
                        <input type="text" id="codigo" placeholder="2023001" required>
                    </div>
                    <div class="form-group">
                        <label for="telefono">Tel√©fono</label>
                        <input type="tel" id="telefono" placeholder="+57 123 456 7890 o 3101234567" required>
                    </div>
                    <div class="form-group">
                        <label for="nombre">Nombre (opcional)</label>
                        <input type="text" id="nombre" placeholder="Tu nombre">
                    </div>
                    <button type="submit" class="btn-primary" style="width: 100%;">Acceder</button>
                </form>
                <div id="loginAlert" class="hidden alert alert-error"></div>
            </div>

            <!-- Secci√≥n de Solicitudes Activas (visible para todos) -->
            <div id="solicitudesActivasSection" class="card">
                <h2 style="margin-top: 0;">üìã Solicitudes Activas</h2>
                
                <!-- Selectores para filtrar por Carrera ‚Üí Materia -->
                <div style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label for="filtroCarrera">Filtrar por Carrera</label>
                        <select id="filtroCarrera" onchange="filtrarPorCarrera()" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 1em;">
                            <option value="">-- Todas las carreras --</option>
                        </select>
                    </div>

                    <div class="form-group" id="filtroGrupoMaterias" style="display: none;">
                        <label for="filtroMateria">Filtrar por Materia</label>
                        <select id="filtroMateria" onchange="cargarSolicitudes()" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 1em;">
                            <option value="">-- Todas las materias --</option>
                        </select>
                    </div>

                    <button class="btn-secondary" onclick="limpiarFiltros()" style="margin-top: 10px;">üîÑ Limpiar Filtros</button>
                </div>

                <div id="solicitudesList" class="empty-state">Cargando solicitudes...</div>
            </div>

            <!-- Secci√≥n de Mis Solicitudes (solo loggeados) -->
            <div id="misSolicitudesSection" class="card hidden">
                <h2 style="margin-top: 0;">‚ú® Mis Solicitudes</h2>
                <button class="btn-primary" onclick="irARegistrarCambio()" 
                        style="margin-bottom: 20px;">+ Nueva Solicitud</button>
                <div id="misSolicitudesList" class="empty-state">Cargando...</div>
            </div>

            <!-- Secci√≥n de B√∫squeda de Materias con Selectores (solo loggeados para registrar) -->
            <div id="registroMateriaSection" class="card hidden">
                <h2>üîç Buscar Materias para Registrar Cambio</h2>
                <div style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label for="selCarrera">1. Proyecto Curricular (Carrera)</label>
                        <select id="selCarrera" onchange="cargarMateriasPorCarrera()" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 1em;">
                            <option value="">-- Selecciona una carrera --</option>
                        </select>
                    </div>

                    <div class="form-group" id="grupoMaterias" style="display: none;">
                        <label for="selMateria">2. Materia</label>
                        <select id="selMateria" onchange="cargarGruposPorMateria()" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 1em;">
                            <option value="">-- Selecciona una materia --</option>
                        </select>
                    </div>

                    <div id="gruposContainer" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
                        <h3 style="color: #667eea; margin-bottom: 15px;">3. Selecciona el grupo que TIENES:</h3>
                        <div id="gruposDisponibles"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para crear solicitud -->
    <div id="solicitudModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="cerrarModal('solicitudModal')">‚úï</button>
            <h2>Crear Solicitud de Cambio</h2>
            <form id="solicitudForm" onsubmit="crearSolicitud(event)">
                <div class="form-group">
                    <label for="solCodigoMateria">C√≥digo Materia</label>
                    <input type="text" id="solCodigoMateria" placeholder="1" required>
                </div>
                <div class="form-group">
                    <label for="solGrupoActual">Grupo que Tengo</label>
                    <input type="text" id="solGrupoActual" placeholder="025-61" required>
                </div>
                <div class="form-group">
                    <label for="solGrupoDeseado">Grupo que Solicito</label>
                    <input type="text" id="solGrupoDeseado" placeholder="025-62" required>
                </div>
                <div class="form-group">
                    <label for="solDescripcion">Descripci√≥n (opcional)</label>
                    <textarea id="solDescripcion" placeholder="Ej: Conflicto con otra materia..." rows="3"></textarea>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%;">Publicar Solicitud</button>
            </form>
        </div>
    </div>

    <!-- Modal para contactar -->
    <div id="contactarModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="cerrarModal('contactarModal')">‚úï</button>
            <h2>üë• Registrarse como Interesado</h2>
            <div class="alert alert-info" style="margin-bottom: 15px;">
                Los contactaremos usando los datos de tu cuenta: <strong id="datosContactoDisplay"></strong>
            </div>
            <form id="contactarForm" onsubmit="enviarContacto(event)">
                <div class="form-group">
                    <label for="conMensaje">Mensaje (opcional)</label>
                    <textarea id="conMensaje" placeholder="Ej: Tengo el grupo que buscas, hablamos?" rows="3"></textarea>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%;">Registrarme como Interesado</button>
            </form>
        </div>
    </div>

    <!-- Modal para ver detalles -->
    <div id="detalleModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="cerrarModal('detalleModal')">‚úï</button>
            <div id="detalleContent"></div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3001/api';
        let token = null;
        let usuarioActual = null;
        let solicitudContactoActual = null;

        // ======================== INIT ========================
        function init() {
            token = localStorage.getItem('token');
            usuarioActual = localStorage.getItem('usuario') && JSON.parse(localStorage.getItem('usuario'));

            // Cargar selectores de filtros de solicitudes p√∫blicas
            cargarFiltrosFacultades();
            cargarSolicitudes();

            if (token) {
                mostrarSecciones();
                cargarFacultadesRegistro();
            } else {
                mostrarLogin();
            }
        }

        // ======================== AUTH ========================
        async function handleLogin(e) {
            e.preventDefault();
            
            const codigo = document.getElementById('codigo').value.trim();
            const telefono = document.getElementById('telefono').value.trim();
            const nombre = document.getElementById('nombre').value.trim();

            if (!codigo || !telefono) {
                mostrarAlert('error', 'Por favor completa los campos requeridos', 'loginAlert');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ codigo, telefono, nombre })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || data.details || 'Error de autenticaci√≥n');
                }

                token = data.token;
                usuarioActual = data.estudiante;

                localStorage.setItem('token', token);
                localStorage.setItem('usuario', JSON.stringify(usuarioActual));

                mostrarSecciones();
                mostrarAlert('success', `¬°Bienvenido ${usuarioActual.nombre || usuarioActual.codigo}!`);
            } catch (error) {
                console.error('Error en login:', error);
                mostrarAlert('error', error.message, 'loginAlert');
            }
        }

        function mostrarLogin() {
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('misSolicitudesSection').classList.add('hidden');
            document.getElementById('registroMateriaSection').classList.add('hidden');
        }

        function mostrarSecciones() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('misSolicitudesSection').classList.remove('hidden');
            document.getElementById('registroMateriaSection').classList.remove('hidden');

            document.getElementById('headerActions').innerHTML = `
                <span style="color: #666; font-weight: 600;">
                    üë§ ${usuarioActual.nombre || usuarioActual.codigo}
                </span>
                <button class="btn-secondary" onclick="logout()">Cerrar Sesi√≥n</button>
            `;

            cargarMisSolicitudes();
        }

        function logout() {
            if (confirm('¬øEst√°s seguro de que deseas cerrar sesi√≥n?')) {
                token = null;
                usuarioActual = null;
                localStorage.removeItem('token');
                localStorage.removeItem('usuario');
                mostrarLogin();
                document.getElementById('headerActions').innerHTML = `
                    <button class="btn-secondary" onclick="mostrarLogin()">Iniciar Sesi√≥n</button>
                `;
            }
        }

        // ======================== SOLICITUDES ========================
        async function cargarSolicitudes() {
            // Construir query con filtros
            const filtroMateria = document.getElementById('filtroMateria').value;
            const query = filtroMateria ? `?materia=${encodeURIComponent(filtroMateria)}` : '';

            try {
                const response = await fetch(`${API_URL}/solicitudes${query}`);
                if (!response.ok) throw new Error('Error al cargar');

                const solicitudes = await response.json();

                if (solicitudes.length === 0) {
                    document.getElementById('solicitudesList').innerHTML = 
                        '<div class="empty-state"><p>No hay solicitudes activas con los filtros seleccionados</p></div>';
                    return;
                }

                document.getElementById('solicitudesList').innerHTML = solicitudes.map(s => `
                    <div class="solicitud-item">
                        <div class="solicitud-header">
                            <div>
                                <div class="materia-nombre">${s.nombre_materia || s.codigo_materia}</div>
                                <span class="status-badge status-${s.estado}">${s.estado}</span>
                            </div>
                        </div>
                        <div class="grupos-info">
                            <div class="grupo-oferta">
                                <strong>Ofrece:</strong> Grupo ${s.grupo_que_ofrece}<br>
                                ${s.docente_ofrece ? `<span style="font-size: 0.85em; color: #666;">üë®‚Äçüè´ ${s.docente_ofrece}</span>` : ''}
                            </div>
                            <div class="grupo-solicita">
                                <strong>Solicita:</strong> Grupo ${s.grupo_que_solicita}<br>
                                ${s.docente_solicita ? `<span style="font-size: 0.85em; color: #666;">üë®‚Äçüè´ ${s.docente_solicita}</span>` : ''}
                            </div>
                        </div>
                        <div class="estudiante-info">
                            <strong>${s.nombre || 'Estudiante'}</strong><br>
                            üìû ${s.telefono}
                        </div>
                        <div style="margin-top: 15px; display: flex; gap: 10px; align-items: center;">
                            <button class="btn-secondary btn-small" onclick="verDetalle(${s.id})">
                                Ver Detalles
                            </button>
                            <a href="https://wa.me/${s.telefono.replace(/\D/g, '')}?text=Hola,%20vi%20tu%20solicitud%20de%20cambio%20para%20${encodeURIComponent(s.nombre_materia || s.codigo_materia)}.%20Me%20interesa%20hacer%20el%20cambio." 
                               target="_blank" 
                               class="btn-success btn-small" 
                               style="text-decoration: none; display: inline-block;">
                                üí¨ WhatsApp
                            </a>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                document.getElementById('solicitudesList').innerHTML = 
                    `<div class="empty-state alert alert-error">${error.message}</div>`;
            }
        }

        async function cargarMisSolicitudes() {
            if (!token) return;

            try {
                const response = await fetch(`${API_URL}/mis-solicitudes`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Error al cargar');

                const solicitudes = await response.json();

                if (solicitudes.length === 0) {
                    document.getElementById('misSolicitudesList').innerHTML = 
                        '<div class="empty-state"><p>No tienes solicitudes a√∫n</p></div>';
                    return;
                }

                document.getElementById('misSolicitudesList').innerHTML = solicitudes.map(s => `
                    <div class="solicitud-item">
                        <div class="solicitud-header">
                            <div>
                                <div class="materia-nombre">${s.nombre_materia || s.codigo_materia}</div>
                                <span class="status-badge status-${s.estado}">${s.estado}</span>
                            </div>
                            <span style="font-size: 0.9em; color: #667eea;">
                                üë• ${s.total_interesados} interesados
                            </span>
                        </div>
                        <div class="grupos-info">
                            <div class="grupo-oferta">
                                <strong>Ofrec√≠:</strong> Grupo ${s.grupo_que_ofrece}<br>
                                ${s.docente_ofrece ? `<span style="font-size: 0.85em; color: #666;">üë®‚Äçüè´ ${s.docente_ofrece}</span>` : ''}
                            </div>
                            <div class="grupo-solicita">
                                <strong>Solicit√©:</strong> Grupo ${s.grupo_que_solicita}<br>
                                ${s.docente_solicita ? `<span style="font-size: 0.85em; color: #666;">üë®‚Äçüè´ ${s.docente_solicita}</span>` : ''}
                            </div>
                        </div>
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button class="btn-secondary btn-small" onclick="verDetalle(${s.id})">
                                Ver (${s.total_interesados} interesados)
                            </button>
                            ${s.estado === 'activa' ? `
                                <button class="btn-secondary btn-small" onclick="cambiarEstado(${s.id}, 'cerrada')">
                                    Cerrar
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function verDetalle(solicitudId) {
            try {
                const response = await fetch(`${API_URL}/solicitudes/${solicitudId}`);
                if (!response.ok) throw new Error('Error al cargar');

                const solicitud = await response.json();

                let html = `
                    <h2>${solicitud.nombre_materia || solicitud.codigo_materia}</h2>
                    <p style="color: #666; margin-bottom: 15px;">
                        ${solicitud.descripcion || 'Sin descripci√≥n adicional'}
                    </p>

                    <div class="grupos-info" style="margin-bottom: 20px;">
                        <div class="grupo-oferta">
                            <strong>Grupo Disponible:</strong><br>
                            ${solicitud.grupo_que_ofrece}
                        </div>
                        <div class="grupo-solicita">
                            <strong>Grupo Buscado:</strong><br>
                            ${solicitud.grupo_que_solicita}
                        </div>
                    </div>

                    <div class="estudiante-info">
                        <strong>Publicado por:</strong><br>
                        üë§ ${solicitud.nombre || 'Estudiante'}<br>
                        üìû ${solicitud.telefono} 
                        <button class="copy-btn" onclick="copiarAlPortapapeles('${solicitud.telefono}')">Copiar</button>
                    </div>
                `;

                if (solicitud.contactos && solicitud.contactos.length > 0) {
                    html += `
                        <div class="interesados-list">
                            <h3 style="margin-top: 20px; margin-bottom: 10px; color: #667eea;">
                                üë• ${solicitud.contactos.length} estudiante(s) interesado(s)
                            </h3>
                            ${solicitud.contactos.map(c => `
                                <div class="interesado-item">
                                    <div class="interesado-nombre">${c.nombre_interesado}</div>
                                    <div class="interesado-contacto">
                                        üìû ${c.telefono_interesado}
                                        <button class="copy-btn" onclick="copiarAlPortapapeles('${c.telefono_interesado}')">
                                            Copiar
                                        </button>
                                        ${c.email_interesado ? `<br>üìß ${c.email_interesado}` : ''}
                                    </div>
                                    ${c.mensaje ? `<div style="margin-top: 8px; font-size: 0.9em; color: #666;">üí¨ "${c.mensaje}"</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                document.getElementById('detalleContent').innerHTML = html;
                document.getElementById('detalleModal').classList.add('active');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function crearSolicitud(e) {
            e.preventDefault();

            const codigoMateria = document.getElementById('solCodigoMateria').value;
            const grupoQueTengo = document.getElementById('solGrupoActual').value;
            const grupoQueSolicito = document.getElementById('solGrupoDeseado').value;
            const descripcion = document.getElementById('solDescripcion').value;

            try {
                const response = await fetch(`${API_URL}/solicitudes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        codigoMateria,
                        grupoQueTengo,
                        grupoQueSolicito,
                        descripcion
                    })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error);

                cerrarModal('solicitudModal');
                document.getElementById('solicitudForm').reset();
                mostrarAlert('success', 'üéâ Solicitud publicada exitosamente!');
                cargarMisSolicitudes();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function cambiarEstado(solicitudId, nuevoEstado) {
            try {
                const response = await fetch(`${API_URL}/solicitudes/${solicitudId}/estado`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ estado: nuevoEstado })
                });

                if (!response.ok) throw new Error('Error al actualizar');

                cargarMisSolicitudes();
                mostrarAlert('success', 'Solicitud actualizada');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // ======================== CONTACTOS ========================
        function mostrarFormularioContacto(solicitudId, grupoOfrecido) {
            if (!token) {
                alert('Debes iniciar sesi√≥n primero');
                return;
            }
            
            solicitudContactoActual = solicitudId;
            
            // Mostrar los datos de contacto del usuario actual
            const datosDisplay = usuarioActual.nombre ? 
                `${usuarioActual.nombre} - ${usuarioActual.telefono}` : 
                usuarioActual.telefono;
            document.getElementById('datosContactoDisplay').textContent = datosDisplay;
            
            document.getElementById('conMensaje').value = 
                `Hola, estoy interesado en tu grupo ${grupoOfrecido}. `;
            document.getElementById('contactarModal').classList.add('active');
        }

        async function enviarContacto(e) {
            e.preventDefault();

            const mensaje = document.getElementById('conMensaje').value.trim();

            try {
                const response = await fetch(
                    `${API_URL}/solicitudes/${solicitudContactoActual}/contactar`,
                    {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ mensaje })
                    }
                );

                const data = await response.json();
                if (!response.ok) throw new Error(data.error || data.mensaje);

                cerrarModal('contactarModal');
                document.getElementById('contactarForm').reset();
                mostrarAlert('success', '‚úÖ Te has registrado como interesado. ' + data.mensaje);
                cargarSolicitudes();
            } catch (error) {
                console.error('Error:', error);
                mostrarAlert('error', 'Error: ' + error.message);
            }
        }

        // ======================== HORARIOS ========================
        // ======================== FILTROS DE SOLICITUDES P√öBLICAS ========================
        async function cargarFiltrosFacultades() {
            try {
                const response = await fetch(`${API_URL}/facultades`);
                if (!response.ok) throw new Error('Error');

                const carreras = await response.json();
                const select = document.getElementById('filtroCarrera');
                
                select.innerHTML = '<option value="">-- Todas las carreras --</option>';
                carreras.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c;
                    option.textContent = c;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error cargando carreras:', error);
            }
        }

        async function filtrarPorCarrera() {
            const carrera = document.getElementById('filtroCarrera').value;
            
            if (!carrera) {
                document.getElementById('filtroGrupoMaterias').style.display = 'none';
                cargarSolicitudes();
                return;
            }

            try {
                const response = await fetch(`${API_URL}/materias-carrera?carrera=${encodeURIComponent(carrera)}`);
                if (!response.ok) throw new Error('Error');

                const materias = await response.json();
                const select = document.getElementById('filtroMateria');
                
                select.innerHTML = '<option value="">-- Todas las materias --</option>';
                materias.forEach(m => {
                    const option = document.createElement('option');
                    option.value = m.codigo;
                    option.textContent = `${m.nombre}`;
                    select.appendChild(option);
                });

                document.getElementById('filtroGrupoMaterias').style.display = 'block';
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function limpiarFiltros() {
            document.getElementById('filtroCarrera').value = '';
            document.getElementById('filtroMateria').value = '';
            document.getElementById('filtroGrupoMaterias').style.display = 'none';
            cargarSolicitudes();
        }

        // ======================== B√öSQUEDA DE MATERIAS PARA REGISTRO ========================
        let carreraRegistroSeleccionada = null;
        let materiaRegistroSeleccionada = null;

        // Cargar carreras para registro
        async function cargarFacultadesRegistro() {
            try {
                const response = await fetch(`${API_URL}/facultades`);
                if (!response.ok) throw new Error('Error');

                const carreras = await response.json();
                const select = document.getElementById('selCarrera');
                
                select.innerHTML = '<option value="">-- Selecciona una carrera --</option>';
                carreras.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c;
                    option.textContent = c;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error cargando carreras:', error);
            }
        }

        async function cargarMateriasPorCarrera() {
            carreraRegistroSeleccionada = document.getElementById('selCarrera').value;
            
            if (!carreraRegistroSeleccionada) {
                document.getElementById('grupoMaterias').style.display = 'none';
                document.getElementById('gruposContainer').style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/materias-carrera?carrera=${encodeURIComponent(carreraRegistroSeleccionada)}`);
                if (!response.ok) throw new Error('Error');

                const materias = await response.json();
                const select = document.getElementById('selMateria');
                
                // Limpiar opciones previas
                select.innerHTML = '<option value="">-- Selecciona una materia --</option>';
                
                materias.forEach(m => {
                    const option = document.createElement('option');
                    option.value = m.codigo;
                    option.textContent = `${m.nombre} (${m.total_grupos} grupos)`;
                    select.appendChild(option);
                });

                document.getElementById('grupoMaterias').style.display = 'block';
                document.getElementById('gruposContainer').style.display = 'none';
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function cargarGruposPorMateria() {
            materiaRegistroSeleccionada = document.getElementById('selMateria').value;
            
            if (!materiaRegistroSeleccionada) {
                document.getElementById('gruposContainer').style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/materias/${materiaRegistroSeleccionada}/grupos`);
                if (!response.ok) throw new Error('Error');

                const grupos = await response.json();
                const container = document.getElementById('gruposDisponibles');

                if (grupos.length === 0) {
                    container.innerHTML = '<p style="color: #999;">No hay grupos disponibles</p>';
                    return;
                }

                container.innerHTML = grupos.map(g => `
                    <div class="solicitud-item" onclick="seleccionarGrupoTengo('${materiaRegistroSeleccionada}', '${g.grupo}', '${g.docente}')" style="cursor: pointer;">
                        <div style="font-weight: 600; color: #667eea; margin-bottom: 8px;">
                            Grupo: ${g.grupo}
                        </div>
                        <div style="font-size: 0.9em; color: #666;">
                            üë®‚Äçüè´ <strong>${g.docente || 'No especificado'}</strong>
                        </div>
                        <div style="font-size: 0.85em; color: #999; margin-top: 8px;">
                            ${g.horarios || 'Horarios no disponibles'}
                        </div>
                        <button class="btn-primary btn-small" onclick="event.stopPropagation(); seleccionarGrupoTengo('${materiaRegistroSeleccionada}', '${g.grupo}', '${g.docente}')">
                            ‚úì Este lo tengo
                        </button>
                    </div>
                `).join('');

                document.getElementById('gruposContainer').style.display = 'block';
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('gruposDisponibles').innerHTML = '<p style="color: red;">Error cargando grupos</p>';
            }
        }

        function seleccionarGrupoTengo(codigoMateria, grupo, docente) {
            if (!token) {
                alert('Debes iniciar sesi√≥n primero');
                return;
            }

            // Pre-llenar el formulario de solicitud
            document.getElementById('solCodigoMateria').value = codigoMateria;
            document.getElementById('solGrupoActual').value = grupo;
            document.getElementById('solGrupoDeseado').value = '';
            document.getElementById('solGrupoDeseado').focus();
            
            // Mostrar modal
            document.getElementById('solicitudModal').classList.add('active');
        }

        // ======================== UTILS ========================
        function irARegistrarCambio() {
            // Hacer scroll suave a la secci√≥n de registro
            const seccion = document.getElementById('registroMateriaSection');
            if (seccion) {
                seccion.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // Opcional: resaltar la secci√≥n brevemente
                seccion.style.boxShadow = '0 0 20px rgba(102, 126, 234, 0.5)';
                setTimeout(() => {
                    seccion.style.boxShadow = '';
                }, 2000);
            }
        }

        function mostrarFormularioSolicitud() {
            if (token) {
                document.getElementById('solicitudModal').classList.add('active');
            } else {
                alert('Debes iniciar sesi√≥n primero');
            }
        }

        function cerrarModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function mostrarAlert(tipo, mensaje, elementId = null) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${tipo}`;
            alert.textContent = mensaje;

            if (elementId) {
                document.getElementById(elementId).innerHTML = '';
                document.getElementById(elementId).appendChild(alert);
            } else {
                const header = document.querySelector('header');
                header.insertAdjacentElement('afterend', alert);
                setTimeout(() => alert.remove(), 5000);
            }
        }

        function copiarAlPortapapeles(texto) {
            navigator.clipboard.writeText(texto).then(() => {
                mostrarAlert('success', 'üìã Copiado al portapapeles');
            });
        }

        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });

        // Inicializar al cargar
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
